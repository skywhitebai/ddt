<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.ddt.dao.custom.CustomFinanceStatisticMapper">

    <select id="getFinanceStatisticInfo"
            resultMap="com.sky.ddt.dao.generate.FinanceStatisticMapper.BaseResultMap">
 SELECT a.*,b.* FROM (SELECT fs.finance_id,fs.month,fs.shop_id,fs.shop_name,SUM(initial_inventory_cost) initial_inventory_cost,SUM(final_inventory_cost) final_inventory_cost,
        SUM(IFNULL(fs.procurement_cost,0)+IFNULL(fs.fba_head_trip_cost,0)) sale_cost,SUM(main_business_income) main_business_income,SUM(main_business_profit) main_business_profit,
        SUM(fs.procurement_cost) sale_procurement_cost,SUM(fs.fba_head_trip_cost) sale_fba_head_trip_cost,sum(fs.sale_quantity) sale_quantity,
        sum(fs.product_sales) product_sales,
        IFNULL(sum(fs.money_back)/sum(fs.product_sales),0) money_back_rate,
         IFNULL(sum(fs.refund_sale_quantity)/sum(fs.sale_quantity),0) refund_rate,
         IFNULL(sum(IFNULL(fs.cost_of_advertising,0)+IFNULL(fs.brand_advertising,0)+IFNULL(fs.display_advertising,0))/sum(fs.product_sales),0)*-1 advertising_sales_percentage,
         IFNULL(sum(fs.main_business_profit)/SUM(IFNULL(fs.procurement_cost,0)+IFNULL(fs.fba_head_trip_cost,0)),0) roi,
         IFNULL(sum(IFNULL(fs.initial_inventory_cost,0)+IFNULL(fs.final_inventory_cost,0))/2/SUM(IFNULL(fs.procurement_cost,0)+IFNULL(fs.fba_head_trip_cost,0))*30,0) inventory_turnover
        FROM `financial_statement` fs
        WHERE fs.`finance_id`=#{financeId}) a ,
        (SELECT SUM(sshtch.fba_send_quantity*(sshtch.head_trip_cost_after+sku.cost_price)) send_cost,SUM(sshtch.fba_send_quantity*sku.cost_price) send_cost_price,SUM(sshtch.fba_send_quantity*sshtch.head_trip_cost_after) send_head_trip_cost_after
       FROM `shop_head_trip_cost` shtc,`shop_sku_head_trip_cost_his` sshtch,finance f,shop_sku ss,sku
   WHERE f.id=#{financeId} AND f.shop_id=shtc.shop_id AND f.month=shtc.month AND shtc.id=sshtch.shop_head_trip_cost_id
   AND sshtch.shop_sku_id=ss.shop_sku_id AND ss.sku_id=sku.`sku_id`) b
    </select>
    <resultMap id="listFinanceStatisticMap"
               type="com.sky.ddt.dto.finance.financeStatistic.response.ListFinanceStatisticResponse"
               extends="com.sky.ddt.dao.generate.FinanceStatisticMapper.BaseResultMap">
        <result column="monthStr" property="monthStr"/>
    </resultMap>
    <select id="listFinanceStatistic"
            resultMap="listFinanceStatisticMap">
        select
        <if test="type =='shop'">
            fs.*
        </if>
        <if test="type =='count'">
            '汇总' shop_name,sum(initial_inventory_cost) initial_inventory_cost,sum(final_inventory_cost)
            final_inventory_cost
            ,sum(send_cost) send_cost,sum(send_cost_price) send_cost_price
            ,sum(send_head_trip_cost_after) send_head_trip_cost_after,sum(sale_cost) sale_cost
            ,sum(main_business_income) main_business_income,sum(manual_adjustment) manual_adjustment
            ,sum(net_income) net_income,sum(main_business_profit) main_business_profit
            ,create_time,update_time
        </if>
        ,date_format(fs.month,'%Y-%m') monthStr from finance_statistic fs
        <where>
            <trim prefix="(" suffix=")" prefixOverrides="and">
                <if test="shopId != null">and fs.shop_id=#{shopId}</if>
                <if test="financeId != null">and fs.finance_id=#{financeId}</if>
                <if test="monthDate != null ">and fs.month=#{monthDate}</if>
            </trim>
        </where>
        <if test="type =='count'">
            group by fs.month
        </if>
        ORDER BY fs.month desc, fs.`shop_name` asc
    </select>

</mapper>